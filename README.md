# System Design - Cоциальная сеть для путешественников

## Функциональные требования:
- web/mob ui
- загрузка фотографий
- создание/обновление постов (фотографии, текст, геометка)
- поставить оценку поста (лайк)
- оставить коментарий под постом
- подписка/отписка на пользователей
- получение списка мест по популярности
- получение списка постов по месту
- получение списка постов других пользователей в обратном хронологическом порядке, основанной на подписке (фид)
- получение списка постов одного пользователя в обратном хронологическом порядке

## Нефункциональные требования:
- DAU ~ 10М
- Активность пользователей: 
    1. В среднем пользователь просматривает ленту (постов + мест + комментарии - batch по 50) ~ 20 запросов в день
    2. В среднем пользователь просматривает ленту (фото) ~150 запросов в день (оценка: с учетом ленивой загрузки и кэширования, не все фото загружаются)
    3. В среднем пользователь лайкает посты ~ 3 запроса в день
    4. В среднем пользователь пишет комментарий 1 раз в день ~ 0.5 запрос в день 
    5. В среднем пользователь создает/обновляет посты 2 раза в неделю в среднем (2/7) ~ 0.3 запрос в день
    6. остальную активность не учитываю (редкие) 
- СНГ аудитория
- Сезонность:
    - Годовая: пики лето/новогодние праздники, минимум осень/весна
    - Недельная: пик выходные
    - Суточная: пик вечер
    - Расчет множителя пиковой нагрузки:
        * Read-операции (просмотр ленты, фото):
          - Годовая (лето): ×1.6
          - Недельная (выходной): ×1.3
          - Суточная (вечер): ×2.0 (максимальный фактор)
          - Итого: ×2.5 (консервативная оценка, не все факторы совпадают одновременно)
        * Write-операции (создание постов):
          - Годовая (лето): ×1.5
          - Недельная (выходной): ×1.2
          - Суточная (вечер): ×1.1
          - Итого: ×2.0 (только активные пользователи создают контент)
        * Write-операции (лайки, комментарии):
          - Годовая (лето): ×1.5
          - Недельная (выходной): ×1.3
          - Суточная (вечер): ×2.0
          - Итого: ×2.5 (консервативная оценка, взаимодействие растет умеренно)
    - Множители для расчетов:
        * Read-операции: ×2.5
        * Write-операции (посты): ×2
        * Write-операции (лайки, комментарии): ×2.5
- Данные храним всегда
- Лимит: 
    1. 1000000 подписчиков
    2. 10 фото в посте
    3. 10000 символов описание поста
- Производительность и SLO:
    - Временные ограничения (максимальное время выполнения):
        1. Публикация поста: ≤ 3 сек
        2. Оценка поста (лайк): ≤ 500 мс
        3. Добавление комментария: ≤ 500 мс
        4. Подписка на пользователя: ≤ 500 мс
        5. Получение популярных мест: ≤ 2 сек
        6. Получение постов популярного места: ≤ 2 сек
        7. Получение ленты (фид): ≤ 2 сек
    - SLO (Service Level Objectives):
        1. Доступность: 99.9% (максимум 43 минуты простоя в месяц)
        2. Latency (процентили):
            - Read-операции (фиды, списки, лайки, комментарии, популярные места):
              * P95 ≤ 1 с
              * P99 ≤ 2 с
            - Write-операции (лайк, комментарий, подписка):
              * P95 ≤ 300 мс (optimistic UI обеспечивает мгновенный отклик)
              * P99 ≤ 500 мс
            - Публикация поста:
              * P95 ≤ 2 с
              * P99 ≤ 3 с

## API

```
GET /places
GET /places/popular
GET /posts
GET /posts/following
GET /posts/{post_id}/comments
GET /posts/{post_id}/likes
POST /likes
POST /comments
POST /posts
POST /uploads/image
```

## Entities

```
User
  id, username, name, avatar_url, status

Follow
  follower_id, followee_id

Post
  id, author_id, description

PostImage
  id, post_id, storage_key, position
  width, height, content_type, size_bytes, hash

Place
  id, name, location, country_code, admin_area
  posts_count, popularity_score

PostPlace
  post_id, place_id, weight

Like
  post_id, user_id

Comment
  id, post_id, user_id, body, parent_id

```

## Оценка нагрузки:

```
Post
  id, author_id: 32 B
  description: ~200 B (среднее)
  likes_count, comments_count: 8 B
  created_at, updated_at: 16 B
  Итого: ~256 B

PostImage
  id, post_id: 32 B
  storage_key: ~100 B
  position, width, height: 12 B
  size_bytes, hash: ~16 B
  Итого: ~150 B

Place
  id: 16 B
  name: ~40 B
  location (геометка): ~32 B
  country_code, admin_area: ~32 B
  posts_count, popularity_score: 12 B
  Итого: ~136 B

PostPlace
  post_id, place_id: 32 B
  weight: 2 B
  Итого: ~34 B

Like
  post_id, user_id: 32 B
  created_at: 8 B
  Итого: ~40 B

Comment
  id, post_id, user_id: 48 B
  parent_id: 16 B
  body: ~140 B (среднее)
  created_at, updated_at: 16 B
  Итого: ~220 B
```
RPS:
  write:
  - Пост: 10000000 * 0.3 / 86400 = ~35 rps
  - Картинки: 10000000 * 0.3 * 5 / 86400 = ~174 rps (0.3 поста в день × 5 фото на пост)
  - Комментарии: 10000000 * 0.5 / 86400 = ~58 rps
  - Лайки: 10000000 * 3 / 86400 = ~347 rps
  read:
  - Лента (посты + места): 10000000 * 20 / 86400 = ~2315 rps
  - Комментарии: 10000000 * 10 / 86400 = ~1157 rps (оценка: ~10 запросов в день при открытии постов)
  - Лайки: 10000000 * 10 / 86400 = ~1157 rps (оценка: ~10 запросов в день)
  - Картинки: 10000000 * 150 / 86400 = ~17361 rps (оценка: с учетом ленивой загрузки - загружаются только фото, попадающие в видимую область при прокрутке)
  пиковая нагрузка (с учетом сезонности):
  write:
  - Пост: 35 rps × 2 = ~70 rps (множитель ×2)
  - Картинки: 174 rps × 2 = ~348 rps (множитель ×2)
  - Комментарии: 58 rps × 2.5 = ~145 rps (множитель ×2.5)
  - Лайки: 347 rps × 2.5 = ~868 rps (множитель ×2.5)
  read:
  - Лента (посты + места): 2315 rps × 2.5 = ~5788 rps (множитель ×2.5)
  - Комментарии: 1157 rps × 2.5 = ~2893 rps (множитель ×2.5)
  - Лайки: 1157 rps × 2.5 = ~2893 rps (множитель ×2.5)
  - Картинки: 17361 rps × 2.5 = ~43403 rps (множитель ×2.5, оценка)

Трафик:
  write:
  - Пост: 35 rps × 1 KB ≈ ~35 KB/s
  - Картинки: 174 rps × 1.5 MB ≈ ~261 MB/s в объектное хранилище
  - Комментарии: 58 rps × 200 B ≈ ~12 KB/s
  - Лайки: 347 rps × 50 B ≈ ~17 KB/s
  read:
  - Лента (посты + места): 2315 rps × 0.5 KB × 50 ≈ ~58 MB/s
  - Комментарии: 1157 rps × 200 B × 20 ≈ ~5 MB/s
  - Лайки: 1157 rps × 50 B ≈ ~58 KB/s
  - Картинки: 17361 rps × 500 KB ≈ ~8.7 GB/s (оценка: с учетом ленивой загрузки - загружаются только видимые фото)
  пиковая нагрузка (с учетом сезонности):
  write:
  - Пост: 70 rps × 1 KB ≈ ~70 KB/s
  - Картинки: 348 rps × 1.5 MB ≈ ~522 MB/s в объектное хранилище
  - Комментарии: 145 rps × 200 B ≈ ~29 KB/s
  - Лайки: 868 rps × 50 B ≈ ~43 KB/s
  read:
  - Лента (посты + места): 5788 rps × 0.5 KB × 50 ≈ ~145 MB/s
  - Комментарии: 2893 rps × 200 B × 20 ≈ ~12 MB/s
  - Лайки: 2893 rps × 50 B ≈ ~145 KB/s
  - Картинки: 43403 rps × 500 KB ≈ ~21.7 GB/s (оценка: с учетом ленивой загрузки - загружаются только видимые фото)

## Расчет одновременных соединений

Connections = 10 000 000 × 0.1 = 1 000 000 одновременных соединений